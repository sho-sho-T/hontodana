name: CI

# on: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼
on:
  push: # æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
    branches: [ main ]
  pull_request: # PRä½œæˆãƒ»æ›´æ–°æ™‚
    branches: [ main ]

# env: ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ä½¿ç”¨ã§ãã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
env:
  NODE_VERSION: "23"


# ========================================
# jobs: å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã®å®šç¾©
# è¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©å¯èƒ½
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä¸¦åˆ—å®Ÿè¡Œã€needsã§ä¾å­˜é–¢ä¿‚ã‚’æŒ‡å®šå¯èƒ½
# ========================================
jobs:
  essential-checks: # ä»»æ„ã®ã‚¸ãƒ§ãƒ–å
    # name: ã‚¸ãƒ§ãƒ–ã®è¡¨ç¤ºåï¼ˆGitHub UIä¸Šã§ã®åå‰ï¼‰
    name: Essential Checks
    runs-on: ubuntu-latest

    steps:
# ========================================
# Step 1: actions/checkout
# å…¬å¼æä¾›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä»–ã®äººãŒä½œã£ãŸå†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†ï¼‰
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆä»®æƒ³ãƒã‚·ãƒ³ï¼‰ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
# ========================================
      - name: Checkout code  # ã‚¹ãƒ†ãƒƒãƒ—ã®åå‰ï¼ˆä»»æ„ï¼‰
        uses: actions/checkout@v4  # ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³@ãƒãƒ¼ã‚¸ãƒ§ãƒ³
      
# ========================================
# Step 2: actions/setup-node
# Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
# æŒ‡å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Node.jsã¨npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:  # ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«æ¸¡ã™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          node-version: ${{ env.NODE_VERSION }}  # ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§
          cache: 'npm'  # npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆé«˜é€ŸåŒ–ï¼‰
          # ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¾‹:
          # registry-url: 'https://npm.pkg.github.com'
          # scope: '@your-org'

# ========================================
# Step 3: run ã‚³ãƒãƒ³ãƒ‰
# uses ã®ä»£ã‚ã‚Šã« run ã‚’ä½¿ç”¨ã™ã‚‹ã¨ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
# ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ï¼ˆLinux/macOSã§ã¯bashï¼‰ã‚’å®Ÿè¡Œ
# ========================================
      - name: Install dependencies
        run: npm ci


  tests:
    name: Tests (Non-blocking) # Githubä¸Šã®åå‰

    # runs-on: å®Ÿè¡Œç’°å¢ƒã®æŒ‡å®š
    # ubuntu-latest: Ubuntuæœ€æ–°ç‰ˆï¼ˆç„¡æ–™æ ã§æœ€ã‚‚ä¸€èˆ¬çš„ï¼‰
    # ä»–ã®é¸æŠè‚¢: windows-latest, macos-latest
    runs-on: ubuntu-latest
    continue-on-error: true # ã“ã®è¨­å®šã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆå¤±æ•—ã§ã‚‚CIã¯æˆåŠŸæ‰±ã„
    
    steps:
      - name: Checkout code # ã‚¹ãƒ†ãƒƒãƒ—ã®åå‰ï¼ˆä»»æ„ï¼‰
        uses: actions/checkout@v4 # ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³@ãƒãƒ¼ã‚¸ãƒ§ãƒ³

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm' # npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆé«˜é€ŸåŒ–ï¼‰

      - name: Install dependencies
        run: npm ci # package-lock.jsonã«åŸºã¥ãç¢ºå®Ÿãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      # ========================================
      # id: ã‚¹ãƒ†ãƒƒãƒ—ã«ä¸€æ„ã®IDã‚’ä»˜ä¸
      # ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’å‚ç…§å¯èƒ½
      # ${{ steps.IDå.outcome }} ã§çµæœã‚’å–å¾—
      # ========================================
      - name: Run tests
        id: test-run
        run: npm run test
        continue-on-error: true

      - name: Test result summary
        if: always()
        run: |
          if [ "${{ steps.test-run.outcome }}" == "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          else
            echo "âš ï¸  ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å¯èƒ½ã§ã™"
            echo "ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆçŠ¶æ³ã‚’ç¢ºèªã—ã€æ®µéšçš„ã«æ”¹å–„ã—ã¦ã„ãã¾ã—ã‚‡ã†"
          fi

      # PRã®å ´åˆã€ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ steps.test-run.outcome }}';
            const emoji = testResult === 'success' ? 'âœ…' : 'âš ï¸';
            const message = testResult === 'success' 
              ? 'ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼' 
              : 'ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å¯èƒ½ã§ã™ã€‚æ®µéšçš„ã«æ”¹å–„ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} ãƒ†ã‚¹ãƒˆçµæœ\n\n${message}\n\nè©³ç´°ã¯[Actionsãƒ­ã‚°](${context.payload.pull_request.html_url}/checks)ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`
            });

  # ========================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ã®ç¢ºèª
  # ========================================
  deployment-ready:
    name: Deployment Ready
    runs-on: ubuntu-latest
    if: always() && needs.essential-checks.result == 'success'
    
    steps:
      - name: Deployment ready confirmation
        run: |
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo ""
          echo "âœ… å¿…é ˆãƒã‚§ãƒƒã‚¯: æˆåŠŸ"
          echo "â„¹ï¸  ãƒ†ã‚¹ãƒˆ: å¤±æ•—ãŒã‚ã£ã¦ã‚‚è¨±å®¹ï¼ˆæ®µéšçš„æ”¹å–„ä¸­ï¼‰"
          echo ""
          echo "ã“ã®ãƒ–ãƒ©ãƒ³ãƒã¯ãƒãƒ¼ã‚¸ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã™ã€‚"

