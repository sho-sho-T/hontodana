# TASK-103: 本棚表示コンポーネント（グリッド・リスト）- 要件定義

## 1. プロジェクト概要

### 目的
ユーザーの書籍コレクションを視覚的に魅力的で使いやすい形で表示するコンポーネント群を実装する。グリッドビューとリストビューの両方に対応し、読書進捗の可視化も含む。

### スコープ
- **対象範囲**: 書籍表示UI層（プレゼンテーション層）
- **技術範囲**: React コンポーネント、TypeScript、Tailwind CSS、Next.js
- **品質範囲**: アクセシビリティ（WCAG 2.1 AA）、レスポンシブデザイン、パフォーマンス

## 2. 機能要件

### 2.1 BookCard コンポーネント（グリッド表示用）

#### 基本表示要素
- **書影**: サムネイル画像（fallback対応）
- **書籍情報**: タイトル、著者、出版社
- **読書状態**: 未読/読書中/読了のステータス
- **進捗バー**: 読書中の場合の進捗率表示
- **操作ボタン**: ステータス変更、削除などのアクション

#### インタラクション
- **ホバー効果**: カード全体のホバー状態
- **クリック操作**: 書籍詳細への遷移
- **キーボード操作**: Tab/Enter/Space キーでの操作

#### レスポンシブ対応
- **デスクトップ**: 4カラムグリッド
- **タブレット**: 3カラムグリッド  
- **モバイル**: 2カラムグリッド

### 2.2 BookList コンポーネント（リスト表示用）

#### 基本表示要素
- **横並びレイアウト**: 書影、書籍情報、進捗、操作を一行表示
- **詳細情報**: タイトル、著者、出版社、ページ数、読書開始日
- **ソート機能**: タイトル、著者、追加日、更新日での並び替え
- **フィルタ表示**: 現在適用中のフィルタ条件

#### インタラクション
- **行選択**: チェックボックス付きの複数選択
- **ドラッグ&ドロップ**: 並び順の変更（将来実装）
- **右クリックメニュー**: コンテキスト操作

### 2.3 ViewToggle コンポーネント（表示切り替え）

#### 基本機能
- **表示モード**: グリッド/リスト の切り替えボタン
- **永続化**: ユーザー設定として保存
- **アニメーション**: 切り替え時のスムーズな遷移

### 2.4 ProgressBar コンポーネント（進捗表示）

#### 基本機能
- **進捗率表示**: パーセンテージとビジュアル表現
- **状態対応**: 読書中のみ表示
- **アニメーション**: 進捗変更時のスムーズな更新

### 2.5 BookSkeleton コンポーネント（ローディング状態）

#### 基本機能
- **スケルトンローダー**: グリッド/リスト両対応
- **パフォーマンス**: 書籍データ読み込み中の UX 向上

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### レンダリング性能
- **初回表示**: 2秒以内
- **表示切り替え**: 300ms以内
- **スクロール性能**: 60fps維持
- **メモリ使用量**: 大量書籍（1000冊+）でも安定動作

#### 最適化技術
- **仮想化**: react-window による大量データ対応
- **遅延読み込み**: 書影の lazy loading
- **メモ化**: React.memo、useMemo の適切な活用

### 3.2 アクセシビリティ要件

#### WCAG 2.1 AA準拠
- **キーボード操作**: 全機能がキーボードでアクセス可能
- **スクリーンリーダー**: 適切なARIA属性とセマンティックHTML
- **色覚対応**: カラーのみに依存しない情報伝達
- **フォーカス管理**: 明確なフォーカス表示と論理的な順序

#### 具体的対応
- **aria-label**: 各操作ボタンに説明的ラベル
- **role属性**: 適切な要素の役割定義
- **見出し構造**: 適切なh1-h6の階層
- **alt属性**: 書影画像の代替テキスト

### 3.3 レスポンシブデザイン要件

#### ブレイクポイント
- **モバイル**: 320px - 767px
- **タブレット**: 768px - 1023px
- **デスクトップ**: 1024px以上

#### 適応要素
- **グリッド列数**: デバイス幅に応じた最適化
- **フォントサイズ**: 可読性を保つサイズ調整
- **タッチターゲット**: 44px×44px以上のタッチ領域
- **余白調整**: デバイスに応じた適切なスペーシング

### 3.4 互換性要件

#### ブラウザ対応
- **デスクトップ**: Chrome, Firefox, Safari, Edge (最新2バージョン)
- **モバイル**: iOS Safari, Chrome Mobile (最新2バージョン)

#### 技術仕様
- **ECMAScript**: ES2020以上
- **CSS**: CSS Grid, Flexbox 対応必須
- **JavaScript**: async/await 対応必須

## 4. 技術仕様

### 4.1 使用技術

#### フロントエンド
- **React 18**: Server Components, Suspense 活用
- **TypeScript**: 厳密な型定義
- **Tailwind CSS**: ユーティリティファーストCSS
- **Next.js 14**: App Router, Server Actions

#### 状態管理
- **React Context**: 表示モード設定
- **Server State**: TASK-102 の Server Actions を活用
- **Local State**: コンポーネント固有状態

#### 外部ライブラリ
- **Lucide React**: アイコン（軽量、Tree-shaking対応）
- **clsx**: 条件付きクラス名生成
- **react-window**: 仮想化スクロール（大量データ対応時）

### 4.2 コンポーネント構成

```
components/
├── library/
│   ├── BookCard.tsx           # グリッド表示用カードコンポーネント
│   ├── BookList.tsx           # リスト表示用コンポーネント
│   ├── BookItem.tsx           # リスト項目コンポーネント
│   ├── ViewToggle.tsx         # 表示切り替えコンポーネント
│   ├── ProgressBar.tsx        # 進捗バーコンポーネント
│   ├── BookSkeleton.tsx       # スケルトンローダー
│   └── LibraryView.tsx        # 全体統合コンポーネント
├── ui/
│   ├── Button.tsx             # 共通ボタンコンポーネント
│   ├── Card.tsx               # 共通カードコンポーネント
│   └── Progress.tsx           # 共通プログレスコンポーネント
```

### 4.3 データフロー

#### Props Interface
```typescript
interface BookCardProps {
  book: UserBookWithBook
  viewMode: 'grid' | 'list'
  onStatusChange: (bookId: string, status: BookStatus) => void
  onRemove: (bookId: string) => void
}

interface LibraryViewProps {
  initialBooks: UserBookWithBook[]
  initialViewMode?: 'grid' | 'list'
}
```

### 4.4 スタイリング仕様

#### デザイントークン
```typescript
const designTokens = {
  colors: {
    card: 'bg-white dark:bg-gray-800',
    border: 'border-gray-200 dark:border-gray-700',
    text: {
      primary: 'text-gray-900 dark:text-gray-100',
      secondary: 'text-gray-600 dark:text-gray-400'
    }
  },
  spacing: {
    card: {
      padding: 'p-4',
      margin: 'gap-4',
      radius: 'rounded-lg'
    }
  },
  animation: {
    hover: 'transition-all duration-200',
    loading: 'animate-pulse'
  }
}
```

## 5. 受け入れ基準

### 5.1 機能受け入れ基準

#### BookCard コンポーネント
- [ ] 書籍の基本情報（タイトル、著者、書影）が正しく表示される
- [ ] 読書ステータスが適切なスタイルで表示される
- [ ] 進捗バーが読書中書籍でのみ表示される
- [ ] ホバー時に適切な視覚フィードバックが提供される
- [ ] クリック時に書籍詳細画面に遷移する

#### BookList コンポーネント
- [ ] 書籍情報がリスト形式で適切に表示される
- [ ] ソート機能が全ての列で正常動作する
- [ ] フィルタ状態が視覚的に分かりやすく表示される
- [ ] 各行での操作が適切に実行される

#### ViewToggle コンポーネント
- [ ] グリッド/リスト表示の切り替えが即座に反映される
- [ ] 選択状態が視覚的に明確に表示される
- [ ] 設定がブラウザリロード後も保持される

### 5.2 品質受け入れ基準

#### パフォーマンス
- [ ] 100冊の書籍表示が2秒以内に完了する
- [ ] 表示切り替えが300ms以内で完了する
- [ ] 書影の遅延読み込みが適切に機能する
- [ ] メモリリークが発生しない

#### アクセシビリティ
- [ ] キーボードのみでの操作が可能
- [ ] スクリーンリーダーで内容が適切に読み上げられる
- [ ] フォーカス表示が明確で論理的な順序
- [ ] WCAG 2.1 AA基準を満たす

#### レスポンシブ
- [ ] 全てのブレイクポイントで適切なレイアウト
- [ ] タッチデバイスでの操作が快適
- [ ] テキストと画像が適切にスケール

### 5.3 エラーハンドリング受け入れ基準

#### データ取得エラー
- [ ] 書籍データ取得失敗時に適切なエラーメッセージ表示
- [ ] 再試行機能が提供される
- [ ] ローディング状態が適切に管理される

#### 画像読み込みエラー
- [ ] 書影読み込み失敗時にfallback画像が表示
- [ ] broken image状態が発生しない
- [ ] 代替テキストが適切に設定される

### 5.4 ユーザビリティ受け入れ基準

#### 視覚的フィードバック
- [ ] すべての操作に明確なフィードバックが提供される
- [ ] ローディング状態が適切にユーザーに伝えられる
- [ ] エラー状態が分かりやすく表示される

#### 操作性
- [ ] 直感的なナビゲーションが提供される
- [ ] 重要な操作に確認ダイアログが表示される
- [ ] キャンセル機能が適切な箇所に配置される

## 6. テスト戦略

### 6.1 単体テスト（Jest + React Testing Library）

#### コンポーネントテスト
- **BookCard**: props受け取り、イベント発火、条件付きレンダリング
- **BookList**: ソート機能、フィルタ表示、アイテム操作
- **ViewToggle**: 状態管理、永続化、表示切り替え
- **ProgressBar**: 進捗率計算、アニメーション、エッジケース

#### カスタムフック
- **useViewMode**: 表示モード管理、localStorage連携
- **useBookActions**: 書籍操作、エラーハンドリング

### 6.2 結合テスト

#### コンポーネント統合
- **LibraryView**: 全コンポーネントの連携動作
- **データフロー**: Server Actions との連携
- **状態管理**: コンポーネント間の状態共有

### 6.3 E2Eテスト（Playwright）

#### ユーザーシナリオ
- **書籍表示**: 初期表示から詳細画面遷移まで
- **表示切り替え**: グリッド⇔リスト変更とデータ永続化
- **読書進捗**: ステータス更新と進捗表示更新
- **レスポンシブ**: 各ブレイクポイントでの動作確認

### 6.4 アクセシビリティテスト

#### 自動テスト
- **@axe-core/react**: 自動アクセシビリティ検証
- **jest-axe**: テスト実行時の継続的チェック

#### 手動テスト
- **キーボードナビゲーション**: Tab/Enter/Space操作
- **スクリーンリーダー**: NVDA/VoiceOverでの読み上げ
- **高コントラストモード**: Windows/macOSでの表示確認

## 7. 実装優先度

### 7.1 Phase 1（MVP）
1. **BookCard**: 基本表示とホバー効果
2. **BookList**: 基本リスト表示
3. **ViewToggle**: 基本切り替え機能
4. **ProgressBar**: 基本進捗表示

### 7.2 Phase 2（機能拡張）
1. **ソート機能**: BookList のソート
2. **スケルトンローダー**: ローディング状態
3. **アクセシビリティ**: ARIA属性とキーボード操作
4. **レスポンシブ**: 各ブレイクポイント対応

### 7.3 Phase 3（最適化）
1. **パフォーマンス**: 仮想化スクロール
2. **アニメーション**: 切り替え時の滑らかな遷移
3. **エラーハンドリング**: 包括的エラー対応
4. **ダークモード**: テーマ対応

## 8. リスクと制約

### 8.1 技術リスク

#### パフォーマンス
- **大量データ**: 1000冊超でのレンダリング性能
- **メモリ使用量**: 書影キャッシュによるメモリリーク
- **バンドルサイズ**: ライブラリ追加によるファイルサイズ増加

#### 互換性
- **ブラウザサポート**: 古いブラウザでのCSS Grid対応
- **モバイル環境**: 低スペック端末での動作
- **アクセシビリティ**: 支援技術との互換性

### 8.2 制約事項

#### デザイン制約
- **既存UI**: shadcn/ui コンポーネントとの統合性
- **ブランディング**: 一貫したデザインシステム
- **レスポンシブ**: 限られたブレイクポイント数

#### 技術制約
- **依存関係**: TASK-102の Server Actions に依存
- **データ構造**: 既存の UserBookWithBook 型に依存
- **状態管理**: 複雑な状態管理ライブラリは使用しない

## 9. 成功指標

### 9.1 技術指標
- **テストカバレッジ**: 90%以上
- **パフォーマンススコア**: Lighthouse 90点以上
- **アクセシビリティスコア**: axe-core 違反 0件
- **バンドルサイズ**: 追加サイズ 50KB以下

### 9.2 ユーザビリティ指標
- **表示速度**: 初回表示 2秒以内
- **操作応答**: ボタンクリック 100ms以内
- **エラー率**: JavaScript エラー 0.1%以下
- **デバイス対応**: 主要モバイル端末 100%動作

### 9.3 保守性指標
- **コード可読性**: SonarQube A評価
- **コンポーネント再利用**: 80%以上の再利用可能性
- **ドキュメント整備**: 全コンポーネントのStorybookドキュメント
- **型安全性**: TypeScript strict mode エラー 0件

## 実装開始準備完了
この要件定義に基づき、次のステップ「テストケース作成」に進みます。