# TASK-201: 検索・フィルタリング機能 - 要件定義

## 概要

本棚に登録された書籍を効率的に検索・フィルタリングする機能を実装する。PostgreSQLの全文検索機能を活用し、複数の条件による絞り込みを可能にする。

## 機能要件

### 1. 全文検索機能

**要件ID**: REQ-005-01
- **説明**: 書籍のタイトル、著者、説明文に対する全文検索
- **実装**: PostgreSQL の `to_tsvector` と `to_tsquery` を使用
- **対応言語**: 日本語、英語
- **検索対象フィールド**:
  - title (書籍タイトル)
  - authors (著者名)
  - description (書籍説明)
  - isbn (ISBN)

### 2. フィルタリング機能

**要件ID**: REQ-104-01
- **説明**: 複数の条件による書籍の絞り込み
- **フィルタ条件**:
  - **読書状態**: 未読、読書中、読了
  - **書籍カテゴリ**: Google Books APIから取得したカテゴリ
  - **評価**: 1-5星評価（実装済みの場合）
  - **登録日**: 期間指定
  - **読書進捗**: 進捗率による範囲指定

### 3. 検索フォームコンポーネント

**要件ID**: REQ-005-02
- **説明**: ユーザーフレンドリーな検索インターフェース
- **機能**:
  - 検索キーワード入力
  - フィルタ条件の設定
  - 検索結果のリアルタイム更新
  - 検索条件のクリア機能

### 4. 検索結果のハイライト

**要件ID**: REQ-005-03
- **説明**: 検索キーワードの強調表示
- **実装**: 検索キーワードをマッチした部分をハイライト表示

### 5. 検索履歴機能

**要件ID**: REQ-005-04
- **説明**: 最近の検索キーワードを保存・表示
- **仕様**:
  - 最大10件まで保存
  - ローカルストレージに保存
  - 履歴からの再検索機能

## 技術仕様

### データベース検索

```sql
-- 全文検索用のインデックス作成
CREATE INDEX books_search_idx ON books 
USING GIN(to_tsvector('japanese', title || ' ' || authors || ' ' || COALESCE(description, '')));

-- 検索クエリ例
SELECT * FROM books 
WHERE to_tsvector('japanese', title || ' ' || authors || ' ' || COALESCE(description, ''))
@@ to_tsquery('japanese', ?);
```

### API仕様

#### 検索API エンドポイント

```typescript
// GET /api/books/search
interface SearchBooksRequest {
  query?: string;                    // 検索キーワード
  status?: 'unread' | 'reading' | 'completed';  // 読書状態
  categories?: string[];             // カテゴリフィルタ
  rating?: number[];                 // 評価フィルタ
  registeredAfter?: string;          // 登録日範囲（開始）
  registeredBefore?: string;         // 登録日範囲（終了）
  progressMin?: number;              // 進捗率（最小）
  progressMax?: number;              // 進捗率（最大）
  page?: number;                     // ページネーション
  limit?: number;                    // 取得件数
}

interface SearchBooksResponse {
  books: BookWithProgress[];
  total: number;
  page: number;
  limit: number;
  hasNext: boolean;
  query: SearchBooksRequest;
}
```

### コンポーネント構成

```
components/
├── search/
│   ├── SearchForm.tsx           # メイン検索フォーム
│   ├── SearchInput.tsx          # 検索キーワード入力
│   ├── FilterPanel.tsx          # フィルタ条件設定
│   ├── SearchResults.tsx        # 検索結果表示
│   ├── SearchHistory.tsx        # 検索履歴
│   └── HighlightedText.tsx      # テキストハイライト
```

## 非機能要件

### パフォーマンス要件

- **検索応答時間**: 3秒以内
- **検索結果表示**: 2秒以内
- **同時検索処理**: 100件まで対応

### UI/UX要件

- **ローディング状態**: 検索中の状態表示
- **エラー表示**: 検索失敗時の適切なメッセージ
- **モバイル対応**: タッチフレンドリーなフィルター操作
- **アクセシビリティ**: スクリーンリーダー対応、キーボード操作

### セキュリティ要件

- **SQLインジェクション対策**: パラメータ化クエリの使用
- **入力値検証**: 検索キーワードとフィルタ条件の検証
- **レート制限**: 過度な検索リクエストの制限

## 受け入れ基準

### 基本機能

- [ ] 書籍タイトルで検索できる
- [ ] 著者名で検索できる
- [ ] 複数キーワードでのAND検索ができる
- [ ] 読書状態でフィルタリングできる
- [ ] カテゴリでフィルタリングできる
- [ ] 複数条件の組み合わせができる

### 検索結果

- [ ] 検索キーワードがハイライトされる
- [ ] 検索結果がページネーションされる
- [ ] 検索条件がクリアできる
- [ ] 検索結果が0件の場合の適切な表示

### ユーザビリティ

- [ ] 検索中のローディング表示
- [ ] 検索履歴が保存される
- [ ] 履歴から再検索できる
- [ ] モバイル端末で正常に動作する

### パフォーマンス

- [ ] 100冊の書籍で3秒以内に検索完了
- [ ] 検索結果表示が2秒以内
- [ ] データベースインデックスが適切に使用される

### エラーハンドリング

- [ ] データベース接続エラーの適切な処理
- [ ] 不正な検索パラメータのエラーハンドリング
- [ ] ネットワークエラー時の再試行機能

## テスト方針

### 単体テスト

- 検索クエリ生成ロジック
- フィルタ条件の組み合わせ
- 検索結果のページネーション
- テキストハイライト機能

### 統合テスト

- データベース検索機能
- API エンドポイントの動作
- フロントエンドとバックエンドの連携

### パフォーマンステスト

- 大量データでの検索性能
- 同時検索リクエストの処理
- メモリ使用量の最適化

### E2Eテスト

- 検索フローの完全なテスト
- フィルタリング機能のテスト
- モバイル端末での操作テスト

## 実装の制約

### データベース制約

- PostgreSQL の全文検索機能を使用
- 既存のテーブル構造を変更しない
- インデックス追加は許可

### パフォーマンス制約

- 検索API の応答時間 3秒以内
- フロントエンドのレンダリング時間 2秒以内
- メモリ使用量の最適化

### 互換性制約

- 既存の書籍表示コンポーネントとの互換性
- モバイル端末でのタッチ操作対応
- 主要ブラウザでの動作保証