# TASK-203: コレクション管理機能 - 要件定義

## 概要

ユーザーが自分の書籍を任意のコレクション（カテゴリ）に整理できる機能を実装します。
既存のデータベーススキーマ（Collection、CollectionBook モデル）を活用し、
直感的なUI/UXでコレクション管理を行えるようにします。

## 機能要件

### FR-203-01: コレクション作成機能
- **要件**: ユーザーが新しいコレクションを作成できること
- **詳細**:
  - コレクション名（必須、最大100文字）
  - 説明（オプション、最大500文字）
  - 色の選択（カラーパレットから選択、デフォルト: #3B82F6）
  - アイコンの選択（絵文字、デフォルト: 📚）
  - 公開/非公開設定（デフォルト: 非公開）
- **制約**:
  - 同一ユーザー内でコレクション名の重複は不可
  - 最大50個までのコレクション作成可能

### FR-203-02: コレクション一覧表示機能
- **要件**: ユーザーのコレクション一覧を表示できること
- **詳細**:
  - グリッド表示でコレクションカードを表示
  - 各カードにアイコン、名前、書籍数、説明を表示
  - 作成日順、名前順、書籍数順でソート可能
  - 空のコレクションも表示
- **UI/UX**:
  - レスポンシブデザイン（モバイル対応）
  - ローディング状態の表示
  - 空状態時のメッセージ表示

### FR-203-03: コレクション編集機能
- **要件**: 既存のコレクションを編集できること
- **詳細**:
  - 名前、説明、色、アイコン、公開設定の変更
  - リアルタイムプレビュー表示
  - 変更の即座反映
- **制約**:
  - 変更時も名前の重複チェック実施

### FR-203-04: コレクション削除機能
- **要件**: コレクションを削除できること
- **詳細**:
  - 確認ダイアログの表示
  - カスケード削除（CollectionBookも削除）
  - 削除後はコレクション一覧から除去
- **制約**:
  - 書籍が含まれる場合は警告メッセージ表示

### FR-203-05: 書籍のコレクション追加機能
- **要件**: 本棚の書籍を既存のコレクションに追加できること
- **詳細**:
  - BookCardからコレクション選択ドロップダウン
  - 複数コレクションへの同時追加可能
  - 既に追加済みのコレクションは選択不可
- **UI/UX**:
  - 追加完了時のトースト通知
  - コレクション選択の検索機能

### FR-203-06: ドラッグ&ドロップ機能
- **要件**: 書籍をドラッグ&ドロップでコレクションに追加できること
- **詳細**:
  - BookCardをコレクションカードにドロップ
  - ドロップゾーンのビジュアルフィードバック
  - ドロップ可能/不可の視覚的区別
- **制約**:
  - タッチデバイスでの代替操作提供
  - 既に含まれる書籍は追加不可

### FR-203-07: コレクション詳細表示機能
- **要件**: コレクション内の書籍一覧を表示できること
- **詳細**:
  - コレクション情報（名前、説明、統計）の表示
  - 含まれる書籍の一覧表示（グリッド/リスト切り替え）
  - 書籍の並び順変更（ドラッグ&ドロップ）
  - 書籍の削除機能
- **UI/UX**:
  - 既存のBookCard、BookListコンポーネント再利用
  - パンくずナビゲーション

### FR-203-08: コレクション内書籍の並び順変更
- **要件**: コレクション内の書籍順序を自由に変更できること
- **詳細**:
  - ドラッグ&ドロップによる並び順変更
  - sortOrderフィールドの自動更新
  - 変更の即座反映
- **制約**:
  - モバイルでは上下矢印ボタンでの操作

## 非機能要件

### NFR-203-01: パフォーマンス
- コレクション一覧表示: 1秒以内
- 書籍追加/削除操作: 2秒以内
- ドラッグ&ドロップ: 60FPS維持

### NFR-203-02: ユーザビリティ
- 直感的なドラッグ&ドロップ操作
- 明確なビジュアルフィードバック
- エラー時の分かりやすいメッセージ

### NFR-203-03: アクセシビリティ
- キーボード操作での全機能利用可能
- スクリーンリーダー対応
- WCAG 2.1 AA準拠

### NFR-203-04: レスポンシブデザイン
- モバイル、タブレット、デスクトップ対応
- タッチ操作の最適化

## データモデル

### Collection テーブル（既存）
```sql
- id: UUID（主キー）
- userId: UUID（外部キー）
- name: String（コレクション名）
- description: String?（説明）
- color: String（カラーコード、デフォルト: #3B82F6）
- icon: String（アイコン絵文字、デフォルト: 📚）
- isPublic: Boolean（公開設定、デフォルト: false）
- sortOrder: Int（表示順、デフォルト: 0）
- createdAt: DateTime
- updatedAt: DateTime
```

### CollectionBook テーブル（既存）
```sql
- id: UUID（主キー）
- collectionId: UUID（外部キー）
- userBookId: UUID（外部キー）
- sortOrder: Int（コレクション内での順序）
- addedAt: DateTime
```

## API エンドポイント

### Server Actions
1. `createCollection(data: CreateCollectionData)` - コレクション作成
2. `updateCollection(id: string, data: UpdateCollectionData)` - コレクション更新
3. `deleteCollection(id: string)` - コレクション削除
4. `getUserCollections(userId: string)` - ユーザーのコレクション一覧取得
5. `addBookToCollection(collectionId: string, userBookId: string)` - 書籍をコレクションに追加
6. `removeBookFromCollection(collectionId: string, userBookId: string)` - コレクションから書籍削除
7. `updateBookOrderInCollection(collectionId: string, bookOrders: {userBookId: string, sortOrder: number}[])` - コレクション内書籍順序更新
8. `getCollectionWithBooks(collectionId: string)` - コレクションと書籍詳細取得

## UI コンポーネント構成

### 新規作成コンポーネント
1. **CollectionCard** - コレクション表示用カード
2. **CollectionList** - コレクション一覧表示
3. **CreateCollectionDialog** - コレクション作成ダイアログ
4. **EditCollectionDialog** - コレクション編集ダイアログ
5. **DeleteCollectionDialog** - コレクション削除確認ダイアログ
6. **CollectionSelector** - 書籍追加時のコレクション選択
7. **CollectionDetailPage** - コレクション詳細ページ
8. **BookCollectionDropzone** - ドロップゾーンコンポーネント

### 既存コンポーネント拡張
1. **BookCard** - コレクション操作ボタン追加
2. **BookList** - ドラッグ&ドロップ対応

## ライブラリ要件

### ドラッグ&ドロップ
- `@dnd-kit/core` - ドラッグ&ドロップ機能
- `@dnd-kit/sortable` - ソート可能リスト
- `@dnd-kit/utilities` - ユーティリティ関数

### UI/UX
- `react-hot-toast` - トースト通知（既存）
- `lucide-react` - アイコン（既存）
- `@radix-ui/react-dialog` - ダイアログ（既存）
- `@radix-ui/react-dropdown-menu` - ドロップダウン（既存）

## エラーハンドリング

### クライアントサイド
1. **バリデーションエラー**
   - 必須フィールド未入力
   - 文字数制限超過
   - 重複チェック

2. **操作エラー**
   - ドラッグ&ドロップ失敗
   - ネットワークエラー
   - 権限エラー

### サーバーサイド
1. **データベースエラー**
   - 制約違反
   - 接続エラー
   - トランザクション失敗

2. **ビジネスロジックエラー**
   - 重複コレクション名
   - 存在しないコレクション/書籍
   - 権限不足

## テスト要件

### 単体テスト
- コレクションCRUD処理の各関数
- バリデーション関数
- データ変換関数

### コンポーネントテスト
- 各UIコンポーネントの表示・動作
- フォーム入力・送信
- ドラッグ&ドロップ操作

### 統合テスト
- Server Actionsの動作
- データベース操作
- エラーハンドリング

### E2Eテスト
- コレクション作成から書籍追加まで
- ドラッグ&ドロップ操作
- レスポンシブ表示

## 実装優先順位

### Phase 1: 基本機能
1. Collection Server Actions実装
2. CollectionCard、CollectionList実装
3. 基本CRUD操作（作成、一覧、編集、削除）

### Phase 2: 書籍管理
1. 書籍のコレクション追加機能
2. コレクション詳細ページ
3. コレクション内書籍管理

### Phase 3: 高度な操作
1. ドラッグ&ドロップ機能
2. 書籍並び順変更
3. UI/UX改善

### Phase 4: 最適化
1. パフォーマンス最適化
2. アクセシビリティ対応
3. レスポンシブ調整

## 受け入れ基準

### 機能的基準
- [ ] ユーザーがコレクションを作成、編集、削除できる
- [ ] 書籍をコレクションに追加・削除できる
- [ ] ドラッグ&ドロップで書籍をコレクションに追加できる
- [ ] コレクション内の書籍順序を変更できる
- [ ] コレクション一覧と詳細が正しく表示される

### 品質基準
- [ ] 全てのテストケースが通ること
- [ ] TypeScriptエラーがないこと
- [ ] アクセシビリティ要件を満たすこと
- [ ] レスポンシブデザインが適切に動作すること
- [ ] パフォーマンス要件を満たすこと

### UX基準
- [ ] 直感的な操作フローであること
- [ ] 適切なフィードバックが提供されること
- [ ] エラー時のメッセージが分かりやすいこと
- [ ] ローディング状態が適切に表示されること